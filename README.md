# Learning and Forecasting of Age–Specific Period Mortality via B–Spline Processes with Locally–Adaptive Dynamic Coefficients

This repository is associated with the article **Learning and Forecasting of Age–Specific Period Mortality via B–Spline Processes with Locally–Adaptive Dynamic Coefficients** and aims at providing detailed materials and codes to implement the general model presented in the article and to **fully reproduce the results presented in Sections 4**.

In order to obtain all the results from the paper, run `main.R`.
A step-by-step explanation on how to implement and fit the model is given in the notebook `application-countries/BSP_stepbystep.Rmd`.


## Further information

The structure of the repository is the following:
```
repository
│   .gitignore
|   .here 
│   LICENSE
│   README.md
│   main.R   
│  
└─── data
│   │   ita_atrisk_period.txt
│   │   ita_deaths_period.txt
│   │   swe_atrisk_period.txt
│   │   swe_deaths_period.txt
│   │   us_atrisk_period.txt
│   │   us_deaths_period.txt
│   │   uk_atrisk_period.txt
│   │   uk_deaths_period.txt
│   
└─── source
│   │   BSP.R
│   │   BSP_forecast.R
│   │   data_processing.R
│   │   helper_fun.R
│   │   setup.R
│   
└─── application-countries
│   │   ITA_BSP.R
│   │   SWE_BSP.R
│   │   UK_BSP.R
│   │   US_BSP.R
│   │   smoothing.R
│   │   plot.R
│   │   BSP_stepbystep.Rmd
|   |   BSP_stepbystep.html
│   │
│   └─── model-comparison
│       │   APC_for.R
│       │   LC_for.R
│       │   CBD_for.R
│       │   RH_for.R
│       │   PLAT_for.R
│       │   HU_for.R
│       │   CP_for.R
│       │   ITA_for.R
│       │   SWE_for.R
│       │   UK_for.R
│       │   US_for.R
│       
└─── output
```
In particular,

- `main.R` contains the call to all the scripts (see next files) necessary to generate all the results of the paper in the folder `output`;
- `data` contains the data as downloaded from the Human Mortality Database;
- `source` contains all the `R` functions to process the data, fit the model, and make forecasts.
In particular,
  - `data_processing.R` contains the preprocessing of the data resulting in a file `output/mortality.Rdata`;
  - `setup.R` contains some setting of the model, such as the spline knots and the kernel function;
  - `BSP.R` contains the code to implement and fit the model;
  - `BSP_forecast.R` contains the code to implement and fit the forecasting model;
  - `helper_fun.R` contains few functions useful to post-process the results and create plot-friendly dataframes.
- `application-countries` contains the reproducible code for the application to US, UK, Sweden, and Italy data, as described in **Section 4** of the paper. In particular,
  - `ITA_BSP.R`, `SWE_BSP.R`, `UK_BSP.R`, `US_BSP.R` implement and fit the model to respective data;
  - `smoothing.R` performs Kalman smoothing on the results of the previous fit;
  - `plot.R` creates the plots of the paper related to the multiple country analysis;
  - `BSP_stepbystep.md` is a notebook showing and commenting the step-by-step model definition, fit, smoothing, and forecast. Once compiled it generates the html file `BSP_stepbystep.html`.
  - `model-comparison` contains the reproducible code to generate **Table 1** for the forecasting comparison with competing model. In particular,
    - `LC_for.R`, `APC_for.R`, `CBD_for.R`, `PLAT_for.R`, `RH_for.R`, `HU_for.R`, and `CP_for.R` (with subfolder `CP`) implements alternative models used in the comparison. Each script fit and forecast the respective model on all the datasets used (country-gender combination); The code in `CP` is taken from the material attached to the original paper "Smooth constrained mortality forecasting" by Camarda (2019).
    - `ITA_BSP_for.R`, `US_BSP_for.R`, `UK_BSP_for.R`, and `SWE_BSP_for.R` fit and forecasts the BSP model on the two datasets (one per gender) for each of the country;
    - `results.R` post-processes the output of the previous scripts to generate **Table 1**.
- `output` contains the output generated by any of the previous scripts;

**Note**: for those who want to inspect the implementation of the functions in `source`, they should keep in mind that the notation of the code uses letter `U` referring to parameters $\beta$ of the model in the paper.

The analyses are performed using `R` version **4.0.3** and `KFAS` package version **1.4.6**.


  
